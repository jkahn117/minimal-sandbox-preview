---
import EditorPane from "./EditorPane.astro";

interface Props {
  sandboxId: string;
  host: string;
}

const { sandboxId, host } = Astro.props;

/**
 * The file inside the sandbox that the editor will load and save.
 * This is the main page component of the vinext app-router-cloudflare example.
 */
const editableFile = "/workspace/examples/app-router-cloudflare/app/page.tsx";
---

<!--
  Sandbox lifecycle + split-pane HMR demo.

  Three states:
    loading  — spinner + progress text while container initializes
    ready    — code editor (left) + live preview iframe (right)
    error    — error message + retry button

  The EditorPane component handles file read/write independently.
  When the user saves, Vite HMR inside the container picks up the
  change and hot-reloads the iframe automatically.
-->

<div
  class="sandbox-container"
  x-data="sandbox"
  data-sandbox-id={sandboxId}
  data-host={host}
  data-editable-file={editableFile}
>
  <!-- Loading state -->
  <div class="loading-state" x-show="state === 'loading'">
    <div class="spinner"></div>
    <div class="status-text" x-text="statusText"></div>
    <div class="step-indicator" x-text="stepKey"></div>
  </div>

  <!-- Ready state: editor + preview -->
  <div class="ready-state" x-show="state === 'ready'" x-cloak>
    <div class="split-pane">
      <div class="editor-pane" x-ref="editorPane">
        <EditorPane />
      </div>
      <div class="preview-pane">
        <iframe
          title="Sandbox Preview"
          loading="lazy"
          :src="previewUrl"
        ></iframe>
      </div>
    </div>
  </div>

  <!-- Error state -->
  <div class="error-state" x-show="state === 'error'" x-cloak>
    <div class="error-message" x-text="errorMessage"></div>
    <button class="retry-btn" @click="location.reload()">Retry</button>
  </div>
</div>

<script>
  /**
   * Thin Alpine.js binding layer. All WS/polling logic lives in
   * SandboxPreview (src/lib/sandbox-preview.ts). This script wires
   * the library's events to Alpine's reactive state, and triggers
   * the EditorPane to load the file once the sandbox is ready.
   */
  import Alpine from "alpinejs";
  import { actions } from "astro:actions";
  import { SandboxPreview, type ActionResult } from "../lib/sandbox-preview";

  const STEP_DESCRIPTIONS: Record<string, string> = {
    creating_workspace: "Creating workspace...",
    cloning_repo: "Cloning vinext repository...",
    installing_dependencies: "Installing dependencies...",
    building_vinext: "Building vinext package...",
    patching_vite_config: "Configuring dev server...",
    starting_server: "Starting vinext dev server...",
    waiting_for_ready: "Waiting for server to be ready...",
    exposing_port: "Configuring preview URL...",
  };

  const containerEl = document.querySelector<HTMLElement>(".sandbox-container");
  const sandboxId = containerEl?.dataset.sandboxId ?? "";
  const host = containerEl?.dataset.host ?? window.location.host;
  const editableFile = containerEl?.dataset.editableFile ?? "";

  /** Adapt Astro Actions' result shape to what SandboxPreview expects. */
  const callAction = async (): Promise<ActionResult> => {
    const result = await actions.startSandbox({ sandboxId, host });
    if (result.error) {
      return { error: { message: result.error.message } };
    }
    const data = result.data as ActionResult["data"];
    return { data };
  };

  Alpine.data("sandbox", () => ({
    state: "loading" as "loading" | "ready" | "error",
    statusText: "Initializing...",
    stepKey: "",
    previewUrl: "",
    errorMessage: "",

    _preview: null as SandboxPreview | null,

    init() {
      const preview = new SandboxPreview({
        start: callAction,
        poll: callAction,
      });

      preview.on("progress", ({ step }) => {
        const baseStep = step.includes(":") ? step.split(":")[0].trim() : step;
        this.statusText = STEP_DESCRIPTIONS[baseStep] ?? step;
        this.stepKey = baseStep;
      });

      preview.on("ready", ({ previewUrl }) => {
        this.state = "ready";
        this.previewUrl = previewUrl;

        // Tell the EditorPane to load the file.
        // $nextTick ensures the editor DOM is visible before we call load().
        this.$nextTick(() => {
          const editorEl = (this.$refs as Record<string, HTMLElement>).editorPane;
          const editorData = Alpine.$data(editorEl?.querySelector("[x-data='editor']") as HTMLElement);
          if (editorData?.load) {
            editorData.load(sandboxId, editableFile);
          }
        });
      });

      preview.on("error", ({ message }) => {
        this.state = "error";
        this.errorMessage = message;
      });

      this._preview = preview;
      preview.init();
    },

    destroy() {
      this._preview?.destroy();
    },
  }));

  Alpine.start();
</script>

<style>
  [x-cloak] {
    display: none !important;
  }

  .sandbox-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Loading */
  .loading-state {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 40px;
    text-align: center;
    height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e3f2fd;
    border-top: 4px solid #2196f3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .step-indicator {
    color: #666;
    font-size: 14px;
    margin-top: 10px;
    font-family: monospace;
  }

  /* Split pane */
  .split-pane {
    display: flex;
    border: 1px solid #333;
    border-radius: 4px;
    overflow: hidden;
    height: 650px;
  }

  .editor-pane {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .preview-pane {
    flex: 1;
    min-width: 0;
    border-left: 2px solid #333;
  }

  .preview-pane iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
  }

  /* Error */
  .error-state {
    text-align: center;
    padding: 40px;
  }

  .error-message {
    color: #d32f2f;
    margin-bottom: 20px;
  }

  .retry-btn {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    background: #2196f3;
    color: white;
    border: none;
    border-radius: 4px;
  }

  .retry-btn:hover {
    background: #1976d2;
  }
</style>
